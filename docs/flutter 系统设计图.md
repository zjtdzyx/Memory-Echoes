# flutter 系统设计图

## 1. 系统架构图 

这张图将展示“记忆回响”应用的高层组件、它们之间的关系，以及关键的数据流向。

**核心用户角色：**

- **用户 (User):** 应用的主要使用者，通过 Flutter App 进行交互。
- **管理员 (Admin):** 仅限于你，直接通过 Firebase 控制台或其他可能的管理界面（未来扩展）管理应用数据。
- **AI 内容审核 Agent (Gemini Agent for Moderation):** 由 Gemini Pro 驱动，负责自动审核用户生成内容。

**核心技术模块/服务：**

1. **Flutter App (客户端)**
2. **Firebase Authentication (用户认证服务)**
3. **Cloud Firestore (云数据库)**
4. **Firebase Storage (云文件存储)**
5. **Google Gemini Pro API (核心 AI 模型)**
6. **Firebase Cloud Functions (未来扩展，用于复杂 AI Agent 逻辑和后端处理)**

**系统架构描述：**

我们将整个系统视为一个以 **Flutter App** 为中心的客户端应用，它直接与多个 **Firebase 服务** 和 **Google Gemini Pro API** 进行交互。AI 内容审核功能将作为后台流程，可能通过 Cloud Functions 触发或在数据写入 Firestore 后执行。

```
+----------------+      +--------------------------+      +---------------------+
|   用户 (User)  |----->|     Flutter App          |----->| Firebase Authentication |
|                |      | (iOS/Android/Web 客户端) |<-----+ (用户注册/登录/会话) |
+----------------+      |                          |      +---------------------+
                        |                          |
                        |       |                  |
                        |       v                  |
                        | +----------------------+ |
                        | |      Dio HTTP Client | |
                        | | (用于调用外部 API)   | |
                        | +----------------------+ |
                        |       |                  |
                        |       v                  |      +---------------------+
                        | +----------------------+ |<---->|   Cloud Firestore   |
                        | | Firebase SDK         | |      | (用户、故事、传记、  |
                        | | (Auth, Firestore,    | |      | 点赞、收藏、对话上下文)|
                        | | Storage 交互)        | |      +---------------------+
                        | +----------------------+ |
                        |       |                  |      +---------------------+
                        |       v                  |----->|   Firebase Storage  |
                        |                          |      | (用户图片/音频文件) |
                        +--------------------------+      +---------------------+
                                  |
                                  | 调用 AI API
                                  v
                        +--------------------------+
                        |  Google Gemini Pro API   |
                        | (核心故事/传记生成，     |
                        |  引导式提问)             |
                        +--------------------------+
                                  ^
                                  |
                                  | (未来扩展 - 内容审核逻辑)
                                  |
                        +--------------------------+
                        | Firebase Cloud Functions |
                        | (AI 内容审核 Agent,       |
                        |  复杂业务逻辑编排)       |
                        +--------------------------+
                                  ^
                                  |
                        +--------------------------+
                        |     管理员 (Admin)       |
                        | (通过 Firebase 控制台管理) |
                        +--------------------------+
```

**数据流向描述：**

1. **用户认证流：**
   - **用户** 通过 **Flutter App** 输入凭证（邮箱/密码）。
   - **Flutter App** 使用 **Firebase SDK** 将凭证发送给 **Firebase Authentication**。
   - **Firebase Authentication** 验证用户身份，并返回认证状态给 **Flutter App**。
   - 用户登录状态和基本信息可能存储在 **Cloud Firestore** 中。
2. **故事/传记生成流 (与 Gemini 交互)：**
   - **用户** 在 **Flutter App** 中输入记忆碎片（文字或语音），或选择现有故事。
   - **Flutter App** 通过 **Dio HTTP Client** 调用 **Google Gemini Pro API**，发送用户输入和必要的上下文。
   - **Google Gemini Pro API** 处理请求并返回 AI 生成的故事文本或引导性问题。
   - **Flutter App** 接收响应并展示给用户。
3. **数据存储与检索流 (与 Firestore/Storage 交互)：**
   - 当 AI 生成故事后，**Flutter App** 将故事文本（可能包含图片/音频的 **Firebase Storage** URL）写入 **Cloud Firestore**。
   - 用户上传图片或音频时，**Flutter App** 将文件上传至 **Firebase Storage**。
   - **Flutter App** 从 **Cloud Firestore** 读取用户的故事列表、传记详情、点赞/收藏数据、对话历史等，并在 UI 中展示。
4. **内容审核流 (未来扩展，由 AI Agent 承担)：**
   - 当用户内容（如故事文本）被写入 **Cloud Firestore** 后，**Cloud Firestore** 可能会触发一个 **Firebase Cloud Function**。
   - 这个 **Cloud Function** 内部会调用 **Google Gemini Pro API**（作为 AI 内容审核 Agent），对新写入的内容进行自动化审核。
   - 审核结果（如“通过”、“需要人工复审”、“已拒绝”）会再次写回 **Cloud Firestore**，标记在对应的故事或传记文档上。
   - **管理员** 可以通过 **Firebase 控制台** 查看被标记的内容进行人工干预。
5. **管理员管理流：**
   - **管理员** 直接通过 **Firebase 控制台** 访问和管理 **Firebase Authentication** (用户数据)、**Cloud Firestore** (应用数据) 和 **Firebase Storage** (文件数据)。

## 2. 模块结构图

**模块结构描述：**

我们将 Flutter App 的 `lib` 目录划分为以下主要模块，并明确它们之间的依赖关系：

```
+------------------------------------------------------------------------------------------------------------------+
|                                              Flutter App (lib/)                                                  |
+------------------------------------------------------------------------------------------------------------------+
|                                                        ^                                                         |
|                                                        |                                                         |
|  +------------------------------------------------------------------------------------------------------------+  |
|  |                                                 presentation/ (展示层)                                      |  |
|  | - pages/                                                                                                   |  |
|  |   - auth/ (认证页面: 登录, 注册)                                                                         |  |
|  |   - story/ (故事页面: 列表, 详情, 创建)                                                                    |  |
|  |   - chat/ (AI 对话页面)                                                                                  |  |
|  |   - biography/ (传记页面: 列表, 详情, 创建)                                                                |  |
|  |   - settings/ (设置页面)                                                                                   |  |
|  | - widgets/ (通用 UI 组件, 无业务逻辑)                                                                      |  |
|  | - providers/ (Riverpod Providers: 管理 UI 状态, 调用 usecase, 将 domain 层数据暴露给 UI)                  |  |
|  | - routes/ (GoRouter 路由配置: 定义路由路径, 参数, 导航守卫)                                                  |  |
|  +------------------------------------------------------------------------------------------------------------+  |
|                                                        ^                                                         |
|                                                        | (调用 UseCases, 管理 UI 状态)                             |
|  +------------------------------------------------------------------------------------------------------------+  |
|  |                                                domain/ (领域层)                                            |  |
|  | - entities/ (纯 Dart 实体类: UserEntity, StoryEntity, BiographyEntity, ChatMessageEntity 等)               |  |
|  | - repositories/ (抽象接口: UserRepository, StoryRepository, AIChatRepository 等, 定义数据操作契约)      |  |
|  | - usecases/ (封装具体业务操作: SignInUseCase, GenerateStoryUseCase, GetStoriesUseCase, GenerateBiographyUseCase 等) |
|  +------------------------------------------------------------------------------------------------------------+  |
|                                                        ^                                                         |
|                                                        | (实现 Repository 接口, 调用 DataSources)                  |
|  +------------------------------------------------------------------------------------------------------------+  |
|  |                                                  data/ (数据层)                                              |  |
|  | - datasources/ (数据源接口与实现: 定义数据来源和获取方式)                                                  |  |
|  |   - remote/                                                                                                |  |
|  |     - auth_remote_datasource.dart (与 Firebase Auth 交互)                                                  |  |
|  |     - firestore_story_datasource.dart (与 Cloud Firestore 交互，故事/传记/点赞/收藏)                      |  |
|  |     - gemini_api_service.dart (与 Google Gemini Pro API 交互)                                               |  |
|  |     - firebase_storage_datasource.dart (与 Firebase Storage 交互)                                          |  |
|  |   - local/                                                                                                 |  |
|  |     - shared_prefs_local_datasource.dart (与 shared_preferences 交互)                                      |  |
|  | - repositories/ (数据仓库实现: UserRepositoryImpl, StoryRepositoryImpl 等, 负责协调 DataSources 并返回 Entity) |
|  | - models/ (数据传输对象 DTOs: 与 API/Firestore JSON 结构对应, 使用 json_serializable)                        |  |
|  +------------------------------------------------------------------------------------------------------------+  |
|                                                        ^                                                         |
|                                                        | (提供通用工具, 常量, 错误处理)                           |
|  +------------------------------------------------------------------------------------------------------------+  |
|  |                                                 core/ (核心基础)                                           |  |
|  | - utils/ (日期格式化, 权限请求, 输入验证, 辅助方法等)                                                      |  |
|  | - constants/ (全局常量: 路由路径, App 颜色/字体定义, API Keys 安全加载配置等)                                |  |
|  | - errors/ (自定义异常类和统一错误处理机制)                                                                 |  |
|  +------------------------------------------------------------------------------------------------------------+  |
```

**依赖关系说明：**

- **`presentation`** 层依赖并调用 **`domain`** 层的 `usecases` 和 `providers`（作为 Riverpod 的中心点）。
- **`domain`** 层（`usecases`）依赖并调用 **`domain`** 层的 `repositories` 接口。
- **`data`** 层（`repositories` 实现）依赖并调用 **`data`** 层的 `datasources`。
- 所有层都可能依赖 **`core`** 层提供的通用工具、常量和错误处理。
- `dependency_injection.dart` 文件将作为 Riverpod providers 的中心注册点，协调各层之间的依赖关系。

## 3. 泳道图

### （1）**用户注册、登录、并开始与AI对话**

用户认证和AI交互的起始点。

**泳道图描述：**

我们将使用不同的“泳道”代表不同的参与者（用户、Flutter App - UI、Flutter App - 业务逻辑/数据层、Firebase Auth、Gemini API）。箭头表示消息或数据流，带标签的矩形表示操作或活动。

```
+-------------------------------------------------------------------------------------------------------------------------+
|                                      用户注册、登录、并开始与 AI 对话                                                   |
+-------------------------------------------------------------------------------------------------------------------------+

+------------------+     +--------------------------+     +----------------------------------+     +---------------------+     +--------------------------+
|     用户         |     |   Flutter App (UI)     |     | Flutter App (业务逻辑/数据层)  |     |   Firebase Auth     |     |   Google Gemini Pro API  |
+------------------+     +--------------------------+     +----------------------------------+     +---------------------+     +--------------------------+
        |                         |                                   |                                     |                                |
        |                         |                                   |                                     |                                |
        |     (1) 访问注册页面    |                                   |                                     |                                |
        |------------------------>|                                   |                                     |                                |
        |                         |   (2) 显示注册表单                |                                     |                                |
        |                         |<----------------------------------|                                     |                                |
        |                         |                                   |                                     |                                |
        |     (3) 输入邮箱/密码   |                                   |                                     |                                |
        |------------------------>|                                   |                                     |                                |
        |                         |                                   |                                     |                                |
        |                         |   (4) 触发注册 UseCase (SignIn/SignUpUseCase)                       |                                |
        |                         |---------------------------------->|                                     |                                |
        |                         |                                   |                                     |                                |
        |                         |                                   |   (5) 调用 Auth Repository         |                                |
        |                         |                                   |------------------------------------>|                                |
        |                         |                                   |                                     | (6) 发送注册请求             |
        |                         |                                   |                                     |----------------------------->|
        |                         |                                   |                                     |                              |
        |                         |                                   |                                     | (7) 返回注册成功/失败      |
        |                         |                                   |<------------------------------------|                              |
        |                         |                                   |                                     |                              |
        |                         |<----------------------------------| (8) 返回注册结果                   |                              |
        |   (9) 显示注册结果      |                                   |                                     |                              |
        |<------------------------|                                   |                                     |                              |
        |                         |                                   |                                     |                              |
        |     (10) 访问登录页面   |                                   |                                     |                              |
        |------------------------>|                                   |                                     |                              |
        |                         |   (11) 显示登录表单               |                                     |                              |
        |                         |<----------------------------------|                                     |                              |
        |                         |                                   |                                     |                              |
        |     (12) 输入邮箱/密码  |                                   |                                     |                              |
        |------------------------>|                                   |                                     |                                |
        |                         |                                   |                                     |                                |
        |                         |   (13) 触发登录 UseCase (SignIn/SignUpUseCase)                      |                                |
        |                         |---------------------------------->|                                     |                                |
        |                         |                                   |                                     |                                |
        |                         |                                   |   (14) 调用 Auth Repository        |                                |
        |                         |                                   |------------------------------------>|                                |
        |                         |                                   |                                     | (15) 发送登录请求            |
        |                         |                                   |                                     |----------------------------->|
        |                         |                                   |                                     |                              |
        |                         |                                   |                                     | (16) 返回登录成功/失败       |
        |                         |                                   |<------------------------------------|                              |
        |                         |                                   |                                     |                              |
        |                         |<----------------------------------| (17) 返回登录结果 (含用户Token/ID) |                              |
        |   (18) 自动跳转主页     |                                   |                                     |                              |
        |<------------------------|                                   |                                     |                              |
        |                         |                                   |                                     |                              |
        |     (19) 在主页输入记忆碎片/选择功能                      |                                     |                              |
        |------------------------>|                                   |                                     |                              |
        |                         |                                   |                                     |                              |
        |                         |   (20) 触发 AI 对话 UseCase (AIChatUseCase)                         |                                |
        |                         |---------------------------------->|                                     |                              |
        |                         |                                   |                                     |                                |
        |                         |                                   |   (21) 调用 AI Chat Repository     |                                |
        |                         |                                   |------------------------------------------------------------------->|
        |                         |                                   |                                                                  | (22) 发送 AI 对话请求 (用户输入+上下文)
        |                         |                                   |                                                                  |----------------------------->
        |                         |                                   |                                                                  |
        |                         |                                   |                                                                  | (23) 返回 AI 响应 (引导问题/故事草稿)
        |                         |                                   |                                                                  |<-----------------------------
        |                         |                                   |<-------------------------------------------------------------------| (24) 返回 AI 响应至业务逻辑
        |                         |                                   |                                     |                                |
        |                         |<----------------------------------| (25) 更新 UI (显示 AI 响应)        |                                |
        |   (26) 用户查看 AI 响应 |                                   |                                     |                                |
        |<------------------------|                                   |                                     |                                |
        |                         |                                   |                                     |                                |
```

**泳道图步骤详解：**

1. **访问注册页面：** 用户通过 App UI 导航到注册页面。
2. **显示注册表单：** App UI 展示注册所需的输入表单（邮箱、密码等）。
3. **输入邮箱/密码：** 用户在表单中输入注册信息。
4. **触发注册 UseCase：** App UI 捕获用户输入，并触发 `SignUpUseCase`（Domain Layer）。
5. **调用 Auth Repository：** `SignUpUseCase` 调用 `AuthRepository` 接口（Domain Layer）。
6. **发送注册请求：** `AuthRepositoryImpl`（Data Layer）通过 Firebase SDK 向 **Firebase Authentication** 发送注册请求。
7. **返回注册成功/失败：** **Firebase Authentication** 处理请求并返回注册结果。
8. **返回注册结果到 App：** 注册结果逐层返回到 Presentation Layer。
9. **显示注册结果：** App UI 根据注册结果显示成功消息或错误提示。
10. **访问登录页面：** 用户通过 App UI 导航到登录页面（或在注册成功后直接跳转）。
11. **显示登录表单：** App UI 展示登录所需的输入表单。
12. **输入邮箱/密码：** 用户输入登录凭证。
13. **触发登录 UseCase：** App UI 触发 `SignInUseCase`（Domain Layer）。
14. **调用 Auth Repository：** `SignInUseCase` 调用 `AuthRepository` 接口。
15. **发送登录请求：** `AuthRepositoryImpl` 通过 Firebase SDK 向 **Firebase Authentication** 发送登录请求。
16. **返回登录成功/失败：** **Firebase Authentication** 处理请求并返回登录结果（包含用户会话令牌/ID）。
17. **返回登录结果到 App：** 登录结果逐层返回到 Presentation Layer。
18. **自动跳转主页：** App UI 接收到登录成功信息后，自动跳转到应用主页。
19. **在主页输入记忆碎片/选择功能：** 用户在主页或对话界面输入新的记忆碎片（文字或语音）。
20. **触发 AI 对话 UseCase：** App UI 触发 `AIChatUseCase`（Domain Layer），并传递用户输入。
21. **调用 AI Chat Repository：** `AIChatUseCase` 调用 `AIChatRepository` 接口。
22. **发送 AI 对话请求：** `AIChatRepositoryImpl`（Data Layer）通过 Dio 调用 **Google Gemini Pro API**，发送用户输入和对话上下文。
23. **返回 AI 响应：** **Google Gemini Pro API** 处理请求并返回 AI 响应（可能是引导问题或初步的故事草稿）。
24. **返回 AI 响应至业务逻辑：** AI 响应逐层返回到 `AIChatUseCase`。
25. **更新 UI：** `AIChatUseCase` 将 AI 响应传递回 Presentation Layer，由 UI 展示给用户。
26. **用户查看 AI 响应：** 用户在 App UI 中看到 AI 的回复。

### （2）用户选择故事生成传记

这张泳道图将展示用户如何从自己的故事库中选择故事，并通过 AI 生成一篇人物传记的全过程。

```
+-------------------------------------------------------------------------------------------------------------------------+
|                                      用户选择故事生成传记                                                               |
+-------------------------------------------------------------------------------------------------------------------------+

+------------------+     +--------------------------+     +----------------------------------+     +--------------------------+
|     用户         |     |   Flutter App (UI)     |     | Flutter App (业务逻辑/数据层)  |     |   Google Gemini Pro API  |
+------------------+     +--------------------------+     +----------------------------------+     +--------------------------+
        |                         |                                   |                                     |
        |     (1) 访问故事库      |                                   |                                     |
        |------------------------>|                                   |                                     |
        |                         |   (2) 显示故事列表                |                                     |
        |                         |<----------------------------------| (从Cloud Firestore获取)             |
        |                         |                                   |                                     |
        |     (3) 选择故事并确认  |                                   |                                     |
        |------------------------>|                                   |                                     |
        |                         |                                   |                                     |
        |                         |   (4) 触发 GenerateBiographyUseCase                               |      |
        |                         |---------------------------------->|                                     |
        |                         |                                   |                                     |
        |                         |                                   |   (5) 调用 Biography Repository    |      |
        |                         |                                   |------------------------------------>|
        |                         |                                   |                                     | (6) 发送选定故事摘要请求
        |                         |                                   |                                     |--------------------------->
        |                         |                                   |                                     |
        |                         |                                   |                                     | (7) 返回 AI 生成的传记文本
        |                         |                                   |                                     |<---------------------------
        |                         |                                   |<------------------------------------| (8) 返回传记文本至业务逻辑
        |                         |                                   |                                     |
        |                         |<----------------------------------| (9) 显示传记草稿                    |
        |     (10) 查看传记草稿   |                                   |                                     |
        |<------------------------|                                   |                                     |
        |                         |                                   |                                     |
        |     (11) 确认/编辑传记  |                                   |                                     |
        |------------------------>|                                   |                                     |
        |                         |                                   |                                     |
        |                         |   (12) 触发 SaveBiographyUseCase                                  |      |
        |                         |---------------------------------->|                                     |
        |                         |                                   |                                     |
        |                         |                                   |   (13) 调用 Biography Repository   |      |
        |                         |                                   |------------------------------------>| (保存到Cloud Firestore)
        |                         |                                   |                                     |
        |                         |<----------------------------------| (14) 返回保存结果                   |
        |     (15) 显示保存成功   |                                   |                                     |
        |<------------------------|                                   |                                     |
        |                         |                                   |                                     |
```

**泳道图步骤详解：**

1. **访问故事库：** 用户在 App 中导航到自己的故事库页面。
2. **显示故事列表：** **Flutter App (UI)** 从 **Cloud Firestore** 获取用户的故事列表并展示。
3. **选择故事并确认：** 用户在 UI 上选择一个或多个故事，并点击“生成传记”按钮确认。
4. **触发 GenerateBiographyUseCase：** **Flutter App (UI)** 触发 `GenerateBiographyUseCase`（属于 **Flutter App - 业务逻辑/数据层**），并传入选定故事的 ID 或内容摘要。
5. **调用 Biography Repository：** `GenerateBiographyUseCase` 调用 `BiographyRepository` 接口。
6. **发送选定故事摘要请求：** `BiographyRepositoryImpl`（属于 **Flutter App - 业务逻辑/数据层**）通过 **Dio HTTP Client** 调用 **Google Gemini Pro API**，发送选定故事的内容摘要。
7. **返回 AI 生成的传记文本：** **Google Gemini Pro API** 处理请求并返回生成的传记文本。
8. **返回传记文本至业务逻辑：** 传记文本逐层返回到 `GenerateBiographyUseCase`。
9. **显示传记草稿：** `GenerateBiographyUseCase` 将生成的传记文本返回给 **Flutter App (UI)** 进行预览。
10. **查看传记草稿：** 用户在 App UI 中查看 AI 生成的传记草稿。
11. **确认/编辑传记：** 用户可对传记草稿进行编辑，并点击确认保存。
12. **触发 SaveBiographyUseCase：** **Flutter App (UI)** 触发 `SaveBiographyUseCase`。
13. **调用 Biography Repository：** `SaveBiographyUseCase` 调用 `BiographyRepository` 接口。
14. **保存传记到 Cloud Firestore：** `BiographyRepositoryImpl` 将最终的传记数据（包括关联的故事 ID 列表）保存到 **Cloud Firestore**。
15. **显示保存成功：** **Flutter App (UI)** 接收保存结果并向用户显示成功提示。

### （3）社交互动（公开与点赞/收藏）

这张泳道图将展示用户如何将自己的故事/传记公开，以及用户如何在社交广场上浏览公开内容并进行点赞/收藏互动。

```
+-------------------------------------------------------------------------------------------------------------------------+
|                                      社交互动（公开与点赞/收藏）                                                          |
+-------------------------------------------------------------------------------------------------------------------------+

+------------------+     +--------------------------+     +----------------------------------+     +---------------------+
|     用户         |     |   Flutter App (UI)     |     | Flutter App (业务逻辑/数据层)  |     |   Cloud Firestore   |
+------------------+     +--------------------------+     +----------------------------------+     +---------------------+
        |                         |                                   |                                     |
        |     (1) 访问个人故事/传记详情页                             |                                     |
        |------------------------>|                                   |                                     |
        |                         |   (2) 显示公开切换按钮/点赞收藏按钮                               |      |
        |                         |<----------------------------------| (从Cloud Firestore获取状态)          |
        |                         |                                   |                                     |
        |     (3) 切换公开状态    |                                   |                                     |
        |------------------------>|                                   |                                     |
        |                         |                                   |   (4) 触发 UpdateStory/BiographyUseCase                       |
        |                         |---------------------------------->|                                     |
        |                         |                                   |                                     |
        |                         |                                   |   (5) 调用 Story/Biography Repository                        |
        |                         |                                   |------------------------------------>| (更新 isPublic 字段)
        |                         |                                   |                                     |
        |                         |<----------------------------------| (6) 返回更新结果                   |
        |     (7) UI 更新状态     |                                   |                                     |
        |<------------------------|                                   |                                     |
        |                         |                                   |                                     |
        |     (8) 访问社交广场/推荐页                             |                                     |
        |------------------------>|                                   |                                     |
        |                         |   (9) 显示公开故事/传记列表       |                                     |
        |                         |<----------------------------------| (从Cloud Firestore查询 isPublic=true) |
        |                         |                                   |                                     |
        |     (10) 查看公开内容并选择互动                             |                                     |
        |------------------------>|                                   |                                     |
        |                         |                                   |                                     |
        |     (11) 点击点赞/收藏按钮                              |                                     |
        |------------------------>|                                   |                                     |
        |                         |                                   |   (12) 触发 ToggleLike/CollectionUseCase                      |
        |                         |---------------------------------->|                                     |
        |                         |                                   |                                     |
        |                         |                                   |   (13) 调用 Like/Collection Repository                      |
        |                         |                                   |------------------------------------>| (创建/删除Like/Collection文档,
        |                         |                                   |                                     | 原子更新Story/Biography计数)
        |                         |                                   |                                     |
        |                         |<----------------------------------| (14) 返回操作结果                  |
        |     (15) UI 更新计数/状态                             |                                     |
        |<------------------------|                                   |                                     |
        |                         |                                   |                                     |
```

**泳道图步骤详解：**

1. **访问个人故事/传记详情页：** 用户导航到自己故事或传记的详情页。
2. **显示公开切换按钮/点赞收藏按钮：** **Flutter App (UI)** 从 **Cloud Firestore** 获取内容的当前状态（如是否公开、点赞数、是否已点赞等），并渲染相应按钮。
3. **切换公开状态：** 用户点击“公开”切换按钮。
4. **触发 UpdateStory/BiographyUseCase：** **Flutter App (UI)** 触发 `UpdateStoryUseCase` 或 `UpdateBiographyUseCase`。
5. **调用 Story/Biography Repository：** UseCase 调用对应的 Repository 接口。
6. **更新 Cloud Firestore：** `RepositoryImpl` 将内容的 `isPublic` 字段更新到 **Cloud Firestore**。
7. **返回更新结果：** Cloud Firestore 返回更新结果。
8. **UI 更新状态：** **Flutter App (UI)** 更新按钮状态，显示内容已公开/私有。
9. **访问社交广场/推荐页：** 用户导航到展示公开故事和传记的“社交广场”或“推荐”页面。
10. **显示公开故事/传记列表：** **Flutter App (UI)** 从 **Cloud Firestore** 查询所有 `isPublic=true` 的故事和传记，并渲染列表。
11. **查看公开内容并选择互动：** 用户在列表中浏览其他用户公开的故事/传记。
12. **点击点赞/收藏按钮：** 用户点击某个公开故事/传记的点赞或收藏按钮。
13. **触发 ToggleLike/CollectionUseCase：** **Flutter App (UI)** 触发 `ToggleLikeUseCase` 或 `ToggleCollectionUseCase`。
14. **调用 Like/Collection Repository：** UseCase 调用对应的 Repository 接口。
15. **更新 Cloud Firestore：** `RepositoryImpl` 将在 **Cloud Firestore** 中执行：
    - **创建/删除** 对应的 `Like` 或 `Collection` 文档。
    - **原子性地增减** 目标故事/传记文档的 `likesCount` 或 `collectionsCount` 字段（通过事务）。
16. **返回操作结果：** Cloud Firestore 返回操作结果。
17. **UI 更新计数/状态：** **Flutter App (UI)** 更新对应内容的点赞/收藏计数和按钮状态。

## 4. 数据流图

### （1）**用户AI对话并生成故事**

**数据流图描述：**

我们将用方框代表系统中的处理单元（Process），用带箭头的线表示数据流（Data Flow），并用数据存储（Data Store）来表示数据的持久化位置。

```
+-----------------------------------------------------------------------+
|                       用户 AI 对话并生成故事                          |
+-----------------------------------------------------------------------+

+------------------+          (1) 用户输入 (文字/语音)           +---------------------------------+
|     用户 (External Entity)   |---------------------------------->|   Flutter App (Presentation Layer)  |
+------------------+                                             |   (UI, Speech-to-Text)          |
                                                                  +---------------------------------+
                                                                                 |
                                                                                 | (2) 调用 AI 对话 UseCase
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (AIChatUseCase, manages context, calls Repository)|
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (3) 调用 AI Chat Repository
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (AIChatRepositoryImpl, calls Remote DataSource) |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (4) 调用 Gemini API Service (HTTP Request)
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |      Gemini API Service (Remote DataSource)     |
                                                    |   (Handles API Key, HTTP Call to Gemini Pro)    |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (5) 发送用户输入 + 上下文
                                                                                 V
            +---------------------------------+ <-------------------------------------------------------
            |  Google Gemini Pro API          |                     (6) 返回 AI 响应 (故事文本/引导问题)
            | (AI Core Model)                 |
            +---------------------------------+
                                                                                 ^
                                                                                 | (7) 返回 AI 响应至 Data Layer
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (Parses AI response)                            |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (8) 返回 AI 响应至 Domain Layer
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (Processes AI response, decide next action)     |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (9) 更新 UI 或触发故事保存 UseCase
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |   Flutter App (Presentation Layer)              |
                                                    | (Displays AI response, Story Preview)           |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (10) 用户确认/编辑故事 (可选)
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (SaveStoryUseCase)                              |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (11) 调用 Story Repository
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (StoryRepositoryImpl, calls Firestore DataSource)|
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (12) 写入故事数据 (可能包含图片/音频 URL)
                                                                                 V
+----------------------------------+<-------------------------------------------------------------------
|  Cloud Firestore                 |
| (故事数据, 对话历史, 图片/音频URL引用) |
+----------------------------------+
```

**数据流步骤详解：**

1. **用户输入：** **用户** 通过 **Flutter App 的 UI (Presentation Layer)** 输入文字记忆碎片，或通过 **`speech_to_text`** 插件进行语音输入。
2. **调用 AI 对话 UseCase：** Presentation Layer 调用 **Domain Layer (AIChatUseCase)**，将用户输入作为参数。
3. **调用 AI Chat Repository：** AIChatUseCase 调用 **Domain Layer** 定义的 **AIChatRepository** 接口。
4. **调用 Gemini API Service：** AIChatRepository 的实现 (在 **Data Layer**) 调用 **Gemini API Service (Remote DataSource)**。
5. **发送请求到 Gemini Pro：** Gemini API Service 通过 **Dio HTTP Client** 将用户输入（以及之前对话的上下文，如果需要）发送给 **Google Gemini Pro API**。
6. **Gemini Pro 返回响应：** **Google Gemini Pro API** 处理请求（智能关联、引导提问、生成故事）并返回 AI 响应。
7. **Data Layer 接收并解析：** Gemini API Service 接收并解析 Gemini Pro 的响应。
8. **返回 AI 响应到 Domain Layer：** Data Layer 将解析后的 AI 响应（可能是新的引导问题或初步的故事文本）返回给 Domain Layer。
9. **更新 UI 或触发故事保存：**
   - 如果是引导性问题，Domain Layer 将其返回给 Presentation Layer 更新 UI，继续对话。
   - 如果是生成的故事文本，Domain Layer 可能会触发一个 **SaveStoryUseCase**。
10. **用户确认/编辑故事：** 在故事生成后，用户可以在 **Flutter App 的 UI** 中进行确认或编辑（可选步骤）。
11. **调用 Story Repository：** Presentation Layer 触发 **Domain Layer (SaveStoryUseCase)** 将故事保存。
12. **写入故事数据到 Firestore：** SaveStoryUseCase 调用 **Domain Layer** 定义的 **StoryRepository** 接口，其实现 (在 **Data Layer**) 将故事数据写入 **Cloud Firestore**。如果故事包含图片或音频，这些文件会先上传到 **Firebase Storage**，其 URL 会被存储在 Firestore 的故事文档中。

### （2）用户选择故事生成传记

这张图将展示用户如何从故事库中选择故事，并通过 AI 生成传记的过程。

```
+--------------------------------------------------------------------------------+
|                   用户选择故事生成传记                                          |
+--------------------------------------------------------------------------------+

+------------------+          (1) 访问故事库列表           +---------------------------------+
|     用户 (External Entity)   |---------------------------------->|   Flutter App (Presentation Layer)  |
+------------------+                                             |   (UI - Story List)             |
                                                                  +---------------------------------+
                                                                                 |
                                                                                 | (2) 从 Cloud Firestore 读取故事列表
                                                                                 V
            +----------------------------------+ <-------------------------------------------------------
            |  Cloud Firestore                 |
            | (存储用户故事数据)                |
            +----------------------------------+
                                                                                 ^
                                                                                 | (3) 渲染故事列表到 UI
                                                    +-------------------------------------------------+
                                                    |   Flutter App (Presentation Layer)              |
                                                    | (Displays Story List, Handles Selection)        |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (4) 用户选择一个或多个故事
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (GenerateBiographyUseCase, selects story content)|
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (5) 调用 Biography Repository
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (BiographyRepositoryImpl, calls Remote DataSource)|
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (6) 调用 Gemini API Service (HTTP Request)
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |      Gemini API Service (Remote DataSource)     |
                                                    |   (Handles API Key, HTTP Call to Gemini Pro)    |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (7) 发送选定故事内容摘要
                                                                                 V
            +---------------------------------+ <-------------------------------------------------------
            |  Google Gemini Pro API          |                     (8) 返回 AI 生成的传记文本
            | (AI Core Model)                 |
            +---------------------------------+
                                                                                 ^
                                                                                 | (9) 返回 AI 响应至 Data Layer
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (Parses AI response)                            |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (10) 返回 AI 响应至 Domain Layer
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (Processes AI biography content)                |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (11) 触发保存传记 UseCase
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |   Flutter App (Presentation Layer)              |
                                                    | (Displays Biography Preview)                    |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (12) 用户确认/编辑传记 (可选)
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (SaveBiographyUseCase)                          |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (13) 调用 Biography Repository
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (BiographyRepositoryImpl, calls Firestore DataSource)|
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (14) 写入传记数据 (包含关联故事ID列表)
                                                                                 V
            +----------------------------------+<-------------------------------------------------------------------
            |  Cloud Firestore                 |
            | (存储用户传记数据, 故事ID引用)      |
            +----------------------------------+
```

**数据流步骤详解：**

1. **访问故事库列表：** 用户通过 **Flutter App 的 UI (Presentation Layer)** 访问个人故事库。
2. **从 Cloud Firestore 读取故事列表：** Presentation Layer 触发 UseCase，Data Layer 从 **Cloud Firestore** 读取用户的全部故事数据。
3. **渲染故事列表到 UI：** App UI 渲染故事列表，用户可以预览并选择故事。
4. **用户选择一个或多个故事：** 用户在 UI 上选择希望用于生成传记的故事。Presentation Layer 触发 **Domain Layer (GenerateBiographyUseCase)**，并传递选定故事的 ID 或内容摘要。
5. **调用 Biography Repository：** `GenerateBiographyUseCase` 调用 `BiographyRepository` 接口。
6. **调用 Gemini API Service：** `BiographyRepository` 的实现 (在 **Data Layer**) 调用 **Gemini API Service (Remote DataSource)**。
7. **发送选定故事内容摘要：** `Gemini API Service` 将选定故事的精炼内容（或其他处理后的文本）发送给 **Google Gemini Pro API**。
8. **Gemini Pro 返回传记文本：** **Google Gemini Pro API** 基于提供的内容生成结构化的个人传记文本。
9. **Data Layer 接收并解析：** `Gemini API Service` 接收并解析 Gemini Pro 的响应。
10. **返回 AI 响应到 Domain Layer：** Data Layer 将解析后的传记文本返回给 Domain Layer。
11. **触发保存传记 UseCase：** Domain Layer 将传记内容返回给 Presentation Layer 展示预览，并触发 **SaveBiographyUseCase**。
12. **用户确认/编辑传记：** 用户在 App UI 中预览 AI 生成的传记，并可进行可选的编辑和确认。
13. **调用 Biography Repository：** Presentation Layer 触发 **Domain Layer (SaveBiographyUseCase)** 保存传记。
14. **写入传记数据到 Firestore：** `SaveBiographyUseCase` 调用 `BiographyRepository` 接口，其实现 (在 **Data Layer**) 将传记数据（包括关联故事 ID 列表）写入 **Cloud Firestore**。

### （3）社交互动（公开与点赞/收藏）

这张图将展示用户如何公开故事/传记，以及用户之间如何进行点赞和收藏互动。

```
+--------------------------------------------------------------------------------+
|                       社交互动（公开与点赞/收藏）                               |
+--------------------------------------------------------------------------------+

+------------------+          (1) 访问故事/传记详情页        +---------------------------------+
|     用户 (External Entity)   |---------------------------------->|   Flutter App (Presentation Layer)  |
+------------------+                                             |   (UI - Story/Biography Detail) |
                                                                  +---------------------------------+
                                                                                 |
                                                                                 | (2) 从 Cloud Firestore 读取详情
                                                                                 V
            +----------------------------------+ <-------------------------------------------------------
            |  Cloud Firestore                 |
            | (存储故事、传记、点赞、收藏数据)    |
            +----------------------------------+
                                                                                 ^
                                                                                 | (3) 渲染详情页到 UI
                                                    +-------------------------------------------------+
                                                    |   Flutter App (Presentation Layer)              |
                                                    | (Displays Detail, Public Toggle, Like/Collect Btn)|
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (4) 用户操作：切换公开状态 或 点赞/收藏
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (UpdateStoryUseCase, UpdateBiographyUseCase,     |
                                                    |  ToggleLikeUseCase, ToggleCollectionUseCase)    |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (5) 调用对应 Repository
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (StoryRepositoryImpl, BiographyRepositoryImpl,   |
                                                    |  LikeRepositoryImpl, CollectionRepositoryImpl)  |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (6) 更新数据到 Cloud Firestore (使用事务处理计数)
                                                                                 V
            +----------------------------------+<-------------------------------------------------------------------
            |  Cloud Firestore                 |
            | (更新 Story/Biography 的 isPublic, |
            |  更新 Likes/Collections collection, |
            |  增减 Story/Biography 的 likesCount/collectionsCount) |
            +----------------------------------+
                                                                                 ^
                                                                                 | (7) 数据更新反馈
                                                    +-------------------------------------------------+
                                                    |   Flutter App (Presentation Layer)              |
                                                    | (Updates UI status - Public/Liked/Collected)    |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (8) 访问“社交广场”/公开内容列表
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |   Flutter App (Presentation Layer)              |
                                                    | (UI - Social Feed)                              |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (9) 从 Cloud Firestore 查询公开的故事/传记
                                                                                 V
            +----------------------------------+ <-------------------------------------------------------
            |  Cloud Firestore                 |
            | (查询 isPublic=true 的故事/传记)    |
            +----------------------------------+
                                                                                 ^
                                                                                 | (10) 渲染公开内容到 UI
                                                    +-------------------------------------------------+
                                                    |   Flutter App (Presentation Layer)              |
                                                    | (Displays Public Stories/Biographies)           |
                                                    +-------------------------------------------------+
```

**数据流步骤详解：**

1. **访问详情页：** 用户访问自己或他人的故事/传记详情页。
2. **从 Cloud Firestore 读取详情：** App 从 **Cloud Firestore** 读取对应故事/传记的详情数据（包括当前的公开状态、点赞/收藏数）。
3. **渲染详情页到 UI：** App UI 展示详情内容，包括公开切换按钮、点赞和收藏按钮。
4. **用户操作：** 用户可以执行以下操作：
   - **切换公开状态：** 用户点击按钮，将自己的故事/传记设置为公开或私有。
   - **点赞/收藏：** 用户点击点赞或收藏按钮（对于公开内容）。
5. **调用对应 UseCase：** Presentation Layer 触发相应的 UseCase (`UpdateStoryUseCase`/`UpdateBiographyUseCase` for public status, `ToggleLikeUseCase`/`ToggleCollectionUseCase` for interaction)。
6. **更新数据到 Cloud Firestore：** `Data Layer` 通过 Repository 实现，将更新请求发送到 **Cloud Firestore**。
   - 对于公开状态：直接更新 `Story/Biography` 文档的 `isPublic` 字段。
   - 对于点赞/收藏：
     - 在 `Likes`/`Collections` 集合中添加/删除对应的文档。
     - **同时，使用 Firestore 事务原子性地增减** `Story`/`Biography` 文档中的 `likesCount`/`collectionsCount` 字段，确保数据一致性。
7. **数据更新反馈：** Cloud Firestore 返回更新结果，并通过 Data Layer 和 Domain Layer 反馈到 Presentation Layer。
8. **更新 UI 状态：** App UI 更新对应内容的公开状态、点赞/收藏按钮的显示状态和计数。
9. **访问“社交广场”/公开内容列表：** 用户导航到展示公开内容的新页面（如“广场”或“推荐”）。
10. **从 Cloud Firestore 查询公开内容：** App 从 **Cloud Firestore** 查询所有 `isPublic=true` 的故事和传记（可能带有分页和排序）。
11. **渲染公开内容到 UI：** App UI 展示这些公开的故事和传记列表，供用户浏览和互动。

### （4）用户注册与登录

这张图将展示用户在“记忆回响”应用中进行注册和登录的全过程。

```
+-----------------------------------------------------------------------+
|                       用户注册与登录                                  |
+-----------------------------------------------------------------------+

+------------------+          (1) 访问注册/登录页面            +---------------------------------+
|     用户 (External Entity)   |---------------------------------->|   Flutter App (Presentation Layer)  |
+------------------+                                             |   (UI - Auth Forms)             |
                                                                  +---------------------------------+
                                                                                 |
                                                                                 | (2) 用户输入凭证 (邮箱/密码)
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (AuthUseCase - e.g., SignUp/SignIn UseCase)   |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (3) 调用 Auth Repository
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (AuthRepositoryImpl, calls Remote DataSource)   |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (4) 调用 Firebase Auth Remote DataSource (SDK Call)
                                                                                 V
            +----------------------------------+ <-------------------------------------------------------
            |  Firebase Authentication         |                     (5) 验证凭证 / 创建用户
            | (用户管理服务)                   |
            +----------------------------------+
                                                                                 ^
                                                                                 | (6) 返回认证结果 (成功/失败/用户ID/Token)
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (AuthRemoteDataSource, parses Auth result)      |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (7) 返回认证结果至 Domain Layer
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (Processes Auth result, updates user state)     |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (8) 更新 UI 状态 / 跳转页面
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |   Flutter App (Presentation Layer)              |
                                                    | (Displays Auth status, Navigates)               |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (9) (仅限首次注册/登录成功) 写入用户基础信息
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |            Flutter App (Domain Layer)           |
                                                    | (SaveUserUseCase, calls UserRepository)         |
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (10) 调用 User Repository
                                                                                 V
                                                    +-------------------------------------------------+
                                                    |             Flutter App (Data Layer)            |
                                                    | (UserRepositoryImpl, calls Firestore DataSource)|
                                                    +-------------------------------------------------+
                                                                                 |
                                                                                 | (11) 写入用户基础数据到 Cloud Firestore
                                                                                 V
            +----------------------------------+<-------------------------------------------------------------------
            |  Cloud Firestore                 |
            | (存储用户基础信息，如 username, avatarUrl) |
            +----------------------------------+
```

**数据流步骤详解：**

1. **访问注册/登录页面：** **用户** 通过 **Flutter App 的 UI (Presentation Layer)** 导航到注册或登录界面。
2. **用户输入凭证：** 用户在表单中输入邮箱和密码。
3. **调用 Auth UseCase：** Presentation Layer 触发 **Domain Layer (AuthUseCase)**，将用户输入作为参数。
4. **调用 Auth Repository：** AuthUseCase 调用 **Domain Layer** 定义的 **AuthRepository** 接口。
5. **调用 Firebase Auth Remote DataSource：** AuthRepository 的实现 (在 **Data Layer**) 调用 **AuthRemoteDataSource**，该数据源通过 **Firebase SDK** 与 **Firebase Authentication** 服务进行通信。
6. **验证凭证/创建用户：** **Firebase Authentication** 接收请求，验证用户凭证（登录）或创建新用户（注册）。
7. **返回认证结果：** **Firebase Authentication** 返回认证结果（成功/失败，以及用户 ID/Token 等）给 Data Layer。
8. **返回认证结果至 Domain Layer：** Data Layer 将结果解析后返回给 Domain Layer。
9. **更新 UI 状态 / 跳转页面：** Domain Layer 根据认证结果更新应用的用户状态，并通知 Presentation Layer 更新 UI（例如，显示成功消息、错误提示或直接跳转到主页）。
10. **(仅限首次注册/登录成功) 写入用户基础信息：** 对于新注册用户或首次登录的用户，Domain Layer 可能会触发一个 `SaveUserUseCase`。
11. **调用 User Repository：** `SaveUserUseCase` 调用 `UserRepository` 接口。
12. **写入用户基础数据到 Cloud Firestore：** `UserRepository` 的实现 (在 **Data Layer**) 将用户的基本信息（如 ID、邮箱、昵称、头像 URL 等）写入 **Cloud Firestore** 的 `users` 集合中。

## 5. 数据模型 E-R 图

我们将使用以下符号来表示 E-R 图的元素：

- **[实体名称]**：代表一个主要的业务对象或数据集合（在 Firestore 中对应一个 Collection）。
- **- 属性名: 数据类型 [约束]**：代表实体的一个字段及其数据类型。
  - **[PK]**：主键 (Primary Key)，唯一标识一个实体实例。
  - **[FK]**：外键 (Foreign Key)，关联到另一个实体的主键。
- **[实体A] -- 关系类型 -- [实体B]**：表示两个实体之间的关系。
  - `1:1`：一对一关系。
  - `1:N`：一对多关系。
  - `M:N`：多对多关系。

#### 核心数据实体：

1. **[User] (用户)**
   - `- id: String [PK]` (来自 Firebase Auth UID)
   - `- email: String`
   - `- username: String` (用户自定义昵称)
   - `- avatarUrl: String?` (头像图片 URL，可选)
   - `- createdAt: Timestamp`
   - `- lastLoginAt: Timestamp`
2. **[Story] (故事)**
   - `- id: String [PK]` (Firestore Document ID)
   - `- userId: String [FK to User.id]`
   - `- title: String` (AI 生成或用户自定义标题)
   - `- content: String` (AI 生成的故事文本)
   - `- imageUrls: List<String>?` (关联的图片文件 URL 列表，来自 Firebase Storage)
   - `- audioUrl: String?` (关联的音频文件 URL，来自 Firebase Storage)
   - `- tags: List<String>?` (故事标签，可选)
   - `- isPublic: Boolean` (是否公开，用于分享，未来扩展)
   - `- moderationStatus: String` (内容审核状态：'pending', 'approved', 'rejected' 等，未来 AI 审核 Agent 更新)
   - `- createdAt: Timestamp`
   - `- updatedAt: Timestamp?`
   - `- lastAIAssistedAt: Timestamp?` (上次 AI 辅助时间)
   - `- likesCount: Integer` (点赞数)
   - `- collectionsCount: Integer` (收藏数)
3. **[Biography] (传记)**
   - `- id: String [PK]` (Firestore Document ID)
   - `- userId: String [FK to User.id]`
   - `- title: String` (传记标题)
   - `- content: String` (AI 生成的传记文本)
   - `- includedStoryIds: List<String>` (包含的故事 ID 列表 [FK to Story.id]，用于追溯传记来源)
   - `- isPublic: Boolean` (是否公开，用于分享，未来扩展)
   - `- moderationStatus: String` (内容审核状态)
   - `- createdAt: Timestamp`
   - `- updatedAt: Timestamp?`
   - `- likesCount: Integer`
   - `- collectionsCount: Integer`
4. **[Like] (点赞)** - 用于记录用户对故事/传记的点赞行为
   - `- id: String [PK]` (Firestore Document ID)
   - `- userId: String [FK to User.id]`
   - `- targetId: String` (被点赞的故事或传记的 ID)
   - `- targetType: String` ('story' or 'biography')
   - `- createdAt: Timestamp`
5. **[Collection] (收藏)** - 用于记录用户对故事/传记的收藏行为
   - `- id: String [PK]` (Firestore Document ID)
   - `- userId: String [FK to User.id]`
   - `- targetId: String` (被收藏的故事或传记的 ID)
   - `- targetType: String` ('story' or 'biography')
   - `- createdAt: Timestamp`
6. **[AIChatMessage] (AI 对话消息)** - 用于存储用户与 AI 的对话历史，以便 AI 维持上下文
   - `- id: String [PK]` (Firestore Document ID)
   - `- sessionId: String` (对话会话 ID，用于关联同一轮对话的所有消息)
   - `- userId: String [FK to User.id]`
   - `- role: String` ('user' or 'ai')
   - `- content: String` (消息内容)
   - `- createdAt: Timestamp`

#### 实体关系：

- **[User] -- 1:N -- [Story]**
  - 一个用户可以拥有多篇故事。
  - `Story.userId` 指向 `User.id`。
- **[User] -- 1:N -- [Biography]**
  - 一个用户可以拥有多篇传记。
  - `Biography.userId` 指向 `User.id`。
- **[User] -- 1:N -- [Like]**
  - 一个用户可以点赞多条内容。
  - `Like.userId` 指向 `User.id`。
- **[Story] -- 1:N -- [Like]** (通过 `Like.targetId` 和 `targetType`)
  - 一篇故事可以被多个用户点赞。
- **[Biography] -- 1:N -- [Like]** (通过 `Like.targetId` 和 `targetType`)
  - 一篇传记可以被多个用户点赞。
- **[User] -- 1:N -- [Collection]**
  - 一个用户可以收藏多条内容。
  - `Collection.userId` 指向 `User.id`。
- **[Story] -- 1:N -- [Collection]** (通过 `Collection.targetId` 和 `targetType`)
  - 一篇故事可以被多个用户收藏。
- **[Biography] -- 1:N -- [Collection]** (通过 `Collection.targetId` 和 `targetType`)
  - 一篇传记可以被多个用户收藏。
- **[Story] -- M:N -- [Biography]** (通过 `Biography.includedStoryIds` 列表实现)
  - 一篇传记可以包含多篇故事。
  - 一篇故事可以被包含在多篇传记中。
- **[User] -- 1:N -- [AIChatMessage]**
  - 一个用户可以有多条对话消息。
  - `AIChatMessage.userId` 指向 `User.id`。
- **[AIChatMessage] -- 1:N (Within Session) -- [AIChatMessage]** (通过 `sessionId` 实现对话上下文)
  - 多条对话消息可以属于同一个会话。

## 6. API 文档

我们将主要关注应用中对外部 API (Gemini Pro) 的调用，并简要提及 Firebase SDK 的交互模式。

### 6.1 Google Gemini Pro API 调用规范

我们的 Flutter App 将主要通过 **Dio HTTP Client** 调用 Gemini Pro API 来实现 AI 核心功能。

**6.1.1 基础信息**

- **API Provider:** Google Cloud (Gemini API)
- **认证方式:** API Key (通过 `X-Goog-Api-Key` HTTP Header 或作为 URL 参数 `key=YOUR_API_KEY` 传递)
  - **重要提示:** API Key 必须通过 `flutter_dotenv` 等安全方式在构建时注入，**严禁硬编码在客户端代码中**。
- **基础 URL:** `https://generativelelanguage.googleapis.com/v1beta` (具体端点根据功能而定)

**6.1.2 核心 API 端点**

我们将主要使用 Gemini Pro 的文本生成功能。

**A. AI 对话与引导式提问 (Text Generation for Chat & Guidance)**

- **描述:** 用户输入记忆碎片后，AI 返回引导性问题或初步关联内容，以帮助用户完善记忆细节。

- **HTTP 方法:** `POST`

- **端点:** `/models/gemini-pro:generateContent`

- **请求 Body (JSON):**

  JSON

  ```
  {
    "contents": [
      {
        "parts": [
          {"text": "你是一个温暖的记忆回响助手，旨在通过提问和关联，帮助用户回顾和记录他们的记忆。请用怀旧、感伤的风格引导对话。用户刚提到了一个记忆碎片，请你温柔地引导他们回忆更多细节，比如时间、地点、人物、感受。"}, // System/Role instruction
          {"text": "用户: "}, // User's initial prompt (from previous turn)
          {"text": "用户输入: [用户的当前记忆碎片或回复]"} // Current user input
        ]
      },
      // 可选: 如果是多轮对话，需要将之前的对话历史也包含进来
      // {
      //   "parts": [
      //     {"text": "用户: 上次你说到..."},
      //     {"text": "模型: 我记得...请问..."},
      //   ]
      // }
    ],
    "safetySettings": [
      // 建议添加安全设置以过滤不当内容
      {
        "category": "HARM_CATEGORY_HARASSMENT",
        "threshold": "BLOCK_MEDIUM_AND_ABOVE"
      },
      // ... 其他类别
    ],
    "generationConfig": {
      "temperature": 0.9, // 温度越高，输出越随机和有创意
      "topK": 1,
      "topP": 1,
      "maxOutputTokens": 200 // 控制生成响应的最大长度
    }
  }
  ```

- **响应 Body (JSON):**

  JSON

  ```
  {
    "candidates": [
      {
        "content": {
          "parts": [
            {"text": "[AI 生成的引导性问题或关联内容，例如：'听起来那是一段特别的时光。你还记得当时具体是哪一年，或者是什么季节吗？当时的天气如何？有没有什么特别的气味让你印象深刻？']"}
          ]
        },
        "finishReason": "STOP"
      }
    ]
  }
  ```

- **错误处理:**

  - HTTP Status 400 Bad Request: 请求参数错误，通常是 `contents` 格式问题或安全设置违规。
  - HTTP Status 403 Forbidden: API Key 无效或权限不足。
  - HTTP Status 429 Too Many Requests: 请求频率过高。
  - HTTP Status 500/503: 服务端内部错误或临时不可用。
  - **应对策略:** Dio 拦截器捕获错误状态码，进行统一的错误消息提示，并可能实现重试机制。

**B. 故事文本生成与润色 (Text Generation for Story & Biography)**

- **描述:** 根据完整的对话内容或选定的故事片段，AI 整理并生成结构化、润色的故事文本或个人传记草稿。

- **HTTP 方法:** `POST`

- **端点:** `/models/gemini-pro:generateContent`

- **请求 Body (JSON):**

  JSON

  ```
  {
    "contents": [
      {
        "parts": [
          {"text": "你是一个专业的叙事者，现在需要你将以下用户的回忆对话内容整理成一篇完整的、带有温暖怀旧感伤风格的日记或故事。请注意事件的逻辑顺序，润色语言，并突出情感细节。"}, // System/Role instruction
          {"text": "对话内容：[这里插入多轮对话的完整历史，或用户选择的多个故事的摘要]"}
        ]
      }
    ],
    "safetySettings": [ ...同上... ],
    "generationConfig": {
      "temperature": 0.8, // 故事生成时温度可略低，追求连贯性
      "maxOutputTokens": 1000 // 故事可能较长，增加最大长度
    }
  }
  ```

- **响应 Body (JSON):**

  JSON

  ```
  {
    "candidates": [
      {
        "content": {
          "parts": [
            {"text": "[AI 生成的结构化故事文本或传记草稿，例如：'那个夏日的午后，阳光透过梧桐叶洒下斑驳的光影...']"}
          ]
        },
        "finishReason": "STOP"
      }
    ]
  }
  ```

- **错误处理:** 同 AI 对话端点。

### 6.2 Firebase SDK 交互模式

对于 Firebase 服务（Authentication, Firestore, Storage），Flutter 应用将主要通过其官方提供的 Dart SDK 进行交互。这些 SDK 封装了底层的 REST API 调用和复杂的认证流程，使得开发者能够以更便捷的 Dart API 进行操作。

- **Firebase Authentication (用户认证):**
  - **主要功能:** `FirebaseAuth.instance.createUserWithEmailAndPassword()`, `FirebaseAuth.instance.signInWithEmailAndPassword()`, `FirebaseAuth.instance.signOut()`, `FirebaseAuth.instance.authStateChanges()` (监听认证状态变化)。
  - **数据流:** Flutter App 直接调用 SDK 方法，SDK 负责与 Firebase Auth 服务通信，处理用户凭证和会话管理。
- **Cloud Firestore (云数据库):**
  - **主要功能:** `FirebaseFirestore.instance.collection('collection_name').doc('doc_id').set/get/update/delete()`, `collection_name.where().orderBy().limit().snapshots()` (实时监听或查询)。
  - **数据流:** Flutter App 通过 SDK 方法进行数据读写。SDK 负责数据同步、离线缓存和安全规则（需在 Firebase 控制台配置）。
  - **数据模型映射:** 应用内 Dart Model (使用 `json_serializable`) 将与 Firestore 文档结构进行相互转换。
- **Firebase Storage (文件存储):**
  - **主要功能:** `FirebaseStorage.instance.ref('path/to/file').putFile/putData()`, `getDownloadURL()`.
  - **数据流:** Flutter App 调用 SDK 上传文件，SDK 处理文件上传到云存储桶，并提供文件的下载 URL。

**重点提醒 Cursor：**

- **错误处理：** 对于所有 Firebase SDK 调用，都需要包含 `try-catch` 块来捕获 `FirebaseAuthException`, `FirebaseException` 等，并提供友好的用户反馈。
- **权限与安全规则：** Firestore 和 Storage 的读写权限需在 Firebase 控制台设置安全规则，Flutter App 只需关注调用 SDK。
- **实时更新：** 利用 Firestore 的 `snapshots()` 特性实现故事列表等实时更新。

